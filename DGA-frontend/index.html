<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Miniapp Frontend</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { font-size: 16px; padding: 10px 15px; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        input[type="text"] { font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: calc(100% - 22px); }
        pre { background-color: #272c34; color: #a5c8ff; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .status { margin-top: 10px; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        /* ซ่อนส่วนที่ยังไม่ Login */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>DGA Miniapp Frontend (Demo)</h1>

        <script>
            const BACKEND_URL = 'https://czp-staging.biza.me/test5';
        </script>

        <script>
            window.czpSdk = {
                getAppId: () => "mock-app-id-from-sdk",
                getToken: () => "mock-mToken-from-sdk-12345"
            };
            console.log("Mock SDK (window.czpSdk) Loaded.");
        </script>


        <div class="section">
            <h2>1. Login Flow (Login & Session)</h2>
            <p>คลิกปุ่มนี้เพื่อจำลองการเรียก SDK และส่ง `mToken` ไปให้ Backend</p>
            <button id="login-btn">Login</button>
            <div id="login-status" class="status" style="display:none;"></div>
        </div>

        <div id="user-info-section" class="section hidden">
            <h2>2. User Data (from Session)</h2>
            <p>ข้อมูลนี้ดึงมาจาก <code>GET /api/get-user-data</code> หลัง Login สำเร็จ</p>
            <pre id="user-data-json"></pre>
        </div>

        <div id="noti-section" class="section hidden">
            <h2>3. Send Notification (Single)</h2>
            <p>ส่งข้อความไปยัง User ID ที่ได้จาก Session (ต้องส่งภายใน 1 ชม. ก่อน Session หมดอายุ)</p>
            <div>
                <input type="text" id="noti-message" value="ทดสอบการส่ง Notification จาก Frontend!">
            </div>
            <br>
            <button id="send-noti-btn">Send Notification</button>
            <div id="noti-status" class="status" style="display:none;"></div>
        </div>

        <div id="batch-section" class="section hidden">
            <h2>4. Test (Batch with Schedule)</h2>
            <p>ทดสอบยิง Endpoint <code>/send-monthly-report-noti</code> (ในโลกจริง Endpoint นี้จะถูกเรียกโดย Cron Job)</p>
            <button id="send-batch-btn">Test Batch Notification</button>
            <div id="batch-status" class="status" style="display:none;"></div>
        </div>
    </div>


    <script>
        // --- ตัวแปรสำหรับเก็บข้อมูล ---
        let currentUserId = null;
        let dgaAppId = null; // เราต้องใช้ AppId ที่ได้จาก DGA, ไม่ใช่ Mock

        // --- 1. ดึง Element ---
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        
        const userInfoSection = document.getElementById('user-info-section');
        const userDataJson = document.getElementById('user-data-json');
        
        const notiSection = document.getElementById('noti-section');
        const notiMessageInput = document.getElementById('noti-message');
        const sendNotiBtn = document.getElementById('send-noti-btn');
        const notiStatus = document.getElementById('noti-status');

        const batchSection = document.getElementById('batch-section');
        const sendBatchBtn = document.getElementById('send-batch-btn');
        const batchStatus = document.getElementById('batch-status');

        // --- 2. กำหนด Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        sendNotiBtn.addEventListener('click', handleSendNotification);
        sendBatchBtn.addEventListener('click', handleSendBatchNotification);

        // --- 3. ฟังก์ชัน Login (Login + Get User) ---
        async function handleLogin() {
            setStatus(loginStatus, 'Logging in...', 'normal');
            loginBtn.disabled = true;

            try {
                // ขั้นตอนที่ 1: เรียก SDK (Mock)
                const mockAppId = window.czpSdk.getAppId();
                const mToken = window.czpSdk.getToken();
                console.log('Got from Mock SDK:', { mockAppId, mToken });

                // ขั้นตอนที่ 2: เรียก Backend /profile/login
                // ⭐️⭐️ credentials: 'include' ⭐️⭐️ 
                // คือส่วนที่ "สำคัญที่สุด" เพื่อให้ Browser ส่งและรับ Cookie (Session)
                const loginResponse = await fetch(`${BACKEND_URL}/profile/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appId: mockAppId, mToken: mToken }),
                    credentials: 'include' 
                });

                if (!loginResponse.ok) {
                    throw new Error(`Login failed (Status: ${loginResponse.status})`);
                }
                
                const loginResult = await loginResponse.json();
                console.log('Login Result:', loginResult);
                setStatus(loginStatus, 'Login successful! Fetching user data...', 'success');

                // ขั้นตอนที่ 3: ถ้า Login สำเร็จ, ให้ดึงข้อมูลผู้ใช้จาก Session ทันที
                await handleGetUserData();

            } catch (error) {
                console.error('Login Flow Error:', error);
                setStatus(loginStatus, `Login Error: ${error.message}`, 'error');
                loginBtn.disabled = false;
            }
        }

        // --- 4. ฟังก์ชันดึงข้อมูลผู้ใช้ (จาก Session) ---
        async function handleGetUserData() {
            try {
                // เรียก /api/get-user-data (Browser จะส่ง Cookie ที่ได้จากข้อ 3 ไปอัตโนมัติ)
                const userResponse = await fetch(`${BACKEND_URL}/api/get-user-data`, {
                    method: 'GET',
                    credentials: 'include' 
                });

                if (!userResponse.ok) {
                    throw new Error(`Failed to get user data (Status: ${userResponse.status})`);
                }
                
                const userData = await userResponse.json();
                console.log('Get User Data Result:', userData);

                // ⭐️ เก็บข้อมูลสำคัญไว้ใช้
                // จากรูป `image_88afc4.png` field ชื่อ `userid`
                currentUserId = userData.userid || userData.userId; 
                // เราต้องใช้ AppId "จริง" ที่ได้จาก DGA ไม่ใช่ตัว Mock
                // (จากรูป ผมเดาว่ามันไม่ได้อยู่ใน Response)
                // dgaAppId = userData.appId; 

                // แสดงผลลัพธ์
                userDataJson.textContent = JSON.stringify(userData, null, 2);
                
                // เปิดส่วนที่ซ่อนไว้
                userInfoSection.classList.remove('hidden');
                notiSection.classList.remove('hidden');
                batchSection.classList.remove('hidden');

            } catch (error) {
                console.error('Get User Data Error:', error);
                setStatus(loginStatus, `Get User Data Error: ${error.message}`, 'error');
                loginBtn.disabled = false;
            }
        }

        // --- 5. ฟังก์ชันส่ง Notification ---
        async function handleSendNotification() {
            const message = notiMessageInput.value;
            if (!currentUserId) {
                alert('Error: User ID not found. Please log in again.');
                return;
            }

            setStatus(notiStatus, 'Sending notification...', 'normal');
            sendNotiBtn.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/send-single-noti`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUserId,
                        message: message
                    }),
                    credentials: 'include' // ใส่ไว้เผื่อ Backend มีการเช็ค Session
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to send notification');
                }

                console.log('Noti Result:', result);
                // (อ้างอิงจากรูป image_890238.png)
                const transactionId = result.result ? result.result[0] : 'N/A';
                setStatus(notiStatus, `Notification sent! TransactionID: ${transactionId}`, 'success');

            } catch (error) {
                console.error('Send Noti Error:', error);
                setStatus(notiStatus, `Send Noti Error: ${error.message}`, 'error');
            } finally {
                sendNotiBtn.disabled = false;
            }
        }

        // --- 6. ฟังก์ชันทดสอบ Batch ---
        async function handleSendBatchNotification() {
            setStatus(batchStatus, 'Sending batch test...', 'normal');
            sendBatchBtn.disabled = true;

             try {
                const response = await fetch(`${BACKEND_URL}/send-monthly-report-noti`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to send batch');
                }

                console.log('Batch Result:', result);
                setStatus(batchStatus, `Batch schedule request sent! (Message: ${result.message})`, 'success');

            } catch (error) {
                console.error('Send Batch Error:', error);
                setStatus(batchStatus, `Send Batch Error: ${error.message}`, 'error');
            } finally {
                sendBatchBtn.disabled = false;
            }
        }

        // --- Helper: ฟังก์ชันแสดง Status ---
        function setStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}`; // 'normal', 'success', 'error'
            element.style.display = 'block';
        }

    </script>
</body>
</html>