<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Miniapp Testing Hub</title>
    <style>
        /* Base Styling */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 30px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e3a8a; margin-bottom: 25px; font-size: 28px; }
        h2 { color: #1e3a8a; margin-bottom: 15px; font-size: 20px; font-weight: 600; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        
        /* Input & Button */
        input[type="text"] { 
            font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; 
            margin-top: 5px; margin-bottom: 10px; transition: border-color 0.3s;
        }
        input[type="text"]:focus { border-color: #4f46e5; outline: none; }
        
        button { 
            font-size: 16px; padding: 12px 15px; border: none; border-radius: 8px; color: white; cursor: pointer; 
            transition: background-color 0.3s, opacity 0.3s; width: 100%; font-weight: 600;
            background-color: #4f46e5;
        }
        button:hover:not(:disabled) { background-color: #4338ca; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Status Box */
        .status { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: 500; display: block; }
        .success-box { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .error-box { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .normal-box { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }

        /* Code Block */
        pre { background-color: #1f2937; color: #d1d5db; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 400px; font-size: 12px; }
        
        /* Hidden Elements */
        .hidden { display: none; }
        
        /* Specific Section Styles */
        #user-info-section { border-color: #a7f3d0; background-color: #f0fff4; }
        #noti-section { border-color: #fca5a5; }
        
        .user-id-display { background-color: #bae6fd; color: #075985; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 14px; }

        /* Color overrides for specific buttons */
        #login-btn { background-color: #1e3a8a; }
        #login-btn:hover:not(:disabled) { background-color: #1e40af; }
        #send-noti-btn { background-color: #dc2626; }
        #send-noti-btn:hover:not(:disabled) { background-color: #b91c1c; }

    </style>
</head>
<body>

    <div class="container">
        <h1>DGA Miniapp Testing Hub</h1>

        <script>
            // ⭐️ ตั้งค่า BACKEND_URL ให้ตรงกับ PORT 1040 ใน server.js
            const BACKEND_URL = 'http://localhost:1040';
        </script>

        <!-- 1. DGA Authentication Flow -->
        <div class="section" style="border-color: #bfdbfe;">
            <h2>1. DGA Authentication Flow (Login)</h2>
            <p style="font-size: 14px; color: #4b5563; margin-bottom: 20px;">
                ขั้นตอน: 1. Validate Token (<code>/api/validate</code>) &rarr; 2. Login ด้วย mToken (<code>/api/login</code>) &rarr; 3. Get Session Data (<code>/api/get-user-data</code>)
            </p>
            <button id="login-btn">
                Start DGA Login Flow
            </button>
            <div id="login-status" class="status" style="display:none;"></div>
        </div>

        <!-- 2. User Data (from Session) -->
        <div id="user-info-section" class="section hidden">
            <h2 style="color: #065f46;">2. User Profile Data (Active Session)</h2>
            <p style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 15px;">
                UserID ที่ใช้ในการส่ง Notification: <span id="display-user-id" class="user-id-display">N/A</span>
            </p>
            <p style="font-size: 14px; color: #6b7280;">
                ข้อมูลที่ถูกดึงมาจาก Session (Backend)
            </p>
            <pre id="user-data-json"></pre>
        </div>

        <!-- 3. Send Notification -->
        <div id="noti-section" class="section hidden">
            <h2 style="color: #b91c1c;">3. Send Notification (Push)</h2>
            <p style="font-size: 14px; color: #4b5563; margin-bottom: 20px;">
                ส่งข้อความไปยัง UserID ด้านบน (ต้องใช้ Token ที่ Validate ใหม่)
            </p>
            <div>
                <label for="noti-message" style="display: block; font-size: 14px; color: #374151; margin-bottom: 5px;">ข้อความแจ้งเตือน:</label>
                <input type="text" id="noti-message" value="ทดสอบการส่ง Notification จาก Frontend!">
            </div>
            <button id="send-noti-btn">
                Send Notification
            </button>
            <div id="noti-status" class="status" style="display:none;"></div>
        </div>

    </div>


    <script>
        // --- Mock DGA SDK (จำลองการทำงานของ Miniapp Platform) ---
        window.czpSdk = {
            getAppId: () => 'MOCK_APP_ID_001',
            getToken: () => 'MOCK_M_TOKEN_' + Math.random().toString(36).substring(2, 10)
        };
        
        // --- ตัวแปรสำหรับเก็บข้อมูล ---
        let currentUserId = null;
        const dgaAppId = window.czpSdk.getAppId(); // ใช้ AppId จาก Mock SDK

        // --- 1. ดึง Element ---
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        const displayUserId = document.getElementById('display-user-id');
        
        const userInfoSection = document.getElementById('user-info-section');
        const userDataJson = document.getElementById('user-data-json');
        
        const notiSection = document.getElementById('noti-section');
        const notiMessageInput = document.getElementById('noti-message');
        const sendNotiBtn = document.getElementById('send-noti-btn');
        const notiStatus = document.getElementById('noti-status');

        // --- 2. กำหนด Event Listeners ---
        loginBtn.addEventListener('click', handleLoginFlow);
        sendNotiBtn.addEventListener('click', handleSendNotificationFlow);

        // --- Helper: ฟังก์ชันแสดง Status ---
        function setStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}-box`; // ใช้คลาสจาก Vanilla CSS
            element.style.display = 'block';
        }

        // --- 3. ฟังก์ชัน Login (Flow ใหม่: Validate -> Login) ---
        async function handleLoginFlow() {
            setStatus(loginStatus, '1/3: กำลังขอ DGA Token...', 'normal');
            loginBtn.disabled = true;

            try {
                const mToken = window.czpSdk.getToken();

                // ขั้นตอนที่ 1: GET /api/validate เพื่อขอ DGA Token
                const validateResponse = await fetch(`${BACKEND_URL}/api/validate`, {
                    method: 'GET',
                    credentials: 'include' 
                });
                const validateResult = await validateResponse.json();
                if (!validateResponse.ok || !validateResult.success) {
                    throw new Error(validateResult.message || 'Validate Token failed.');
                }
                const dgaToken = validateResult.token;
                setStatus(loginStatus, '2/3: Token ผ่าน! กำลังแลก mToken เป็นข้อมูลผู้ใช้...', 'normal');


                // ขั้นตอนที่ 2: POST /api/login เพื่อแลก mToken เป็นข้อมูลผู้ใช้
                const loginResponse = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        appId: dgaAppId, 
                        mToken: mToken, 
                        token: dgaToken 
                    }),
                    credentials: 'include' 
                });
                
                const loginResult = await loginResponse.json();
                if (!loginResponse.ok || !loginResult.success) {
                    throw new Error(loginResult.message || 'Login failed.');
                }
                
                setStatus(loginStatus, '3/3: Login สำเร็จ! กำลังดึงข้อมูลจาก Session...', 'success');

                // ขั้นตอนที่ 3: ดึงข้อมูลผู้ใช้จาก Session
                await handleGetUserData();

            } catch (error) {
                console.error('Login Flow Error:', error);
                setStatus(loginStatus, `Login Error: ${error.message}`, 'error');
                loginBtn.disabled = false;
            }
        }

        // --- 4. ฟังก์ชันดึงข้อมูลผู้ใช้ (จาก Session) ---
        async function handleGetUserData() {
            try {
                const userResponse = await fetch(`${BACKEND_URL}/api/get-user-data`, {
                    method: 'GET',
                    credentials: 'include' 
                });

                if (!userResponse.ok) {
                    throw new Error(`Failed to get user data (Status: ${userResponse.status})`);
                }
                
                const userData = await userResponse.json();

                currentUserId = userData.userId; 
                
                // แสดงผลลัพธ์
                userDataJson.textContent = JSON.stringify(userData, null, 2);
                displayUserId.textContent = currentUserId;
                
                // เปิดส่วนที่ซ่อนไว้
                userInfoSection.classList.remove('hidden');
                notiSection.classList.remove('hidden');
                
                loginBtn.disabled = true;

            } catch (error) {
                console.error('Get User Data Error:', error);
                setStatus(loginStatus, `Failed to retrieve session data: ${error.message}`, 'error');
                loginBtn.disabled = false;
            }
        }

        // --- 5. ฟังก์ชันส่ง Notification (Flow ใหม่: Validate -> Notify) ---
        async function handleSendNotificationFlow() {
            const message = notiMessageInput.value;
            if (!currentUserId) {
                setStatus(notiStatus, 'Error: ไม่พบ User ID กรุณา Login ก่อน', 'error');
                return;
            }

            setStatus(notiStatus, '1/2: กำลังขอ Token สำหรับส่ง Notification...', 'normal');
            sendNotiBtn.disabled = true;

            try {
                // ขั้นตอนที่ 1: GET /api/validate เพื่อขอ DGA Token ใหม่
                const validateResponse = await fetch(`${BACKEND_URL}/api/validate`, {
                    method: 'GET',
                    credentials: 'include' 
                });
                const validateResult = await validateResponse.json();
                if (!validateResponse.ok || !validateResult.success) {
                    throw new Error(validateResult.message || 'Validate Token failed.');
                }
                const dgaToken = validateResult.token;
                setStatus(notiStatus, '2/2: Token ได้รับแล้ว. กำลังส่ง Notification...', 'normal');

                // ขั้นตอนที่ 2: POST /api/notification
                const response = await fetch(`${BACKEND_URL}/api/notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appId: dgaAppId,
                        userId: currentUserId,
                        token: dgaToken,
                        message: message
                    }),
                    credentials: 'include' 
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'Failed to send notification');
                }
                
                const transactionId = result.result?.result?.[0]?.transactionID || 'N/A';
                setStatus(notiStatus, `ส่ง Notification สำเร็จ! TransactionID: ${transactionId}`, 'success');

            } catch (error) {
                console.error('Send Noti Flow Error:', error);
                setStatus(notiStatus, `Send Noti Error: ${error.message}`, 'error');
            } finally {
                sendNotiBtn.disabled = false;
            }
        }
    </script>
</body>
</html>